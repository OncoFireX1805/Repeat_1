---
title: "Repet_1"
author: "Parth"
date: "2024-04-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Install all packages 
```{r}
install.packages("tidyverse")
library(tidyverse)
library(ggplot2)
library(dplyr)
library(DESeq2)

```
```{r}
library(AnnotationDbi)
library(org.Hs.eg.db)
```
Obtaining the data and mearging the files for Dseq2 analysis 

```{r}
library(tximport)
library(DESeq2)
library(readr)

# List the directories in the salmon_quant directory
dirs <- list.files("C:/Users/parth/OneDrive/Desktop/rnaseq_data/salmon_quant")

# List the files in the salmon_quant directory
quant_files <- list.files("C:/Users/parth/OneDrive/Desktop/rnaseq_data/salmon_quant",
                          pattern = "quant.sf",
                          recursive = TRUE,
                          full.names = TRUE)

# Assign names to quant_files based on directory names
names(quant_files) <- dirs

# Read transcript-to-gene mapping CSV file
tx2gene <- read_csv("C:/Users/parth/OneDrive/Desktop/rnaseq_data/tx2gene.csv", col_names = FALSE)

# Import transcript-level abundance estimates using tximport
txi <- tximport(files = quant_files,
                type = "salmon",
                tx2gene = tx2gene,
                ignoreTxVersion = TRUE)

# Read sample information from TSV file
sampleinfo <- read_tsv("C:/Users/parth/OneDrive/Desktop/rnaseq_data/meta_data/sampleInfo_corrected.txt")

# Create DESeqDataSet object
dds <- DESeqDataSetFromTximport(txi, 
                                colData = sampleinfo,
                                design = ~Treated)

```


Now view all the files 
```{r}
library(tidyverse)
View(quant_files)
View(dds)
tibble(tx2gene)
View(sampleinfo)

```
So for now we have imported all the files and we are good to go, to perform Dseq 2 analysis we have to convert the condtion variable to make R treat them as numberical values First check
```{r}
type(dds$condition)
```
Now convert this in numnber--- did not understand why this did not work?
```{r}
dds$condition <- as.factor(dds$condition)
type(dds$condition)
```
create a directory and save everything in R objects file 
```{r}
dir.create("Robjects",showWarnings = FALSE)
saveRDS(dds,file = "Robjects/dds.rds")
```

Workflow 
```{r}
colData(dds)
```
Now desgin the experiment (try conditon here) and perform differential seq analysis 
```{r}
design(dds)<-~condition
de_conditon<-DESeq(dds)
results(de_conditon)

```
```{r}
results(de_conditon,tidy = TRUE)
```
Sorting data properly for analysis 
```{r}
library(dplyr)
library(tidyverse)
library(DESeq2)
results(de_conditon,tidy = TRUE)%>% arrange(padj)%>% head(n=100)
```

Now the main workflow, create directory, files and perform DSEq2 major analysis 
```{r}
dir.create("de_analysis",showWarnings = FALSE)
results(de_conditon,tidy = TRUE)%>%arrange(desc(padj>0.05))%>%write.csv("conditional_analysis.csv")
```

Now save an RDS copy of this file important for graph making 
```{r}
saveRDS(de_conditon,file = "conditional_analysis")

```
check the file 
```{r}
results(de_conditon)
library(tidyverse)
de_conditon
```
Plot an MA plot 
```{r}
plotMA(de_conditon)
```
Check individual datapoints 
```{r}
plotCounts(dds,"ENSG00000158258",intgroup = "condition")
```
Changing direction of contrast 
```{r}
# Assuming you're working with the limma package for differential expression analysis

# Specify the contrasts you're interested in
contrasts_of_interest <- c("condition", "CTR", "TGF")

# Assuming `de_condition` represents your design matrix or contrast matrix
# Call `results()` function with the necessary arguments
results <- results(de_conditon, contrast = contrasts_of_interest)

# Now you can proceed with further operations on `results`, such as summarizing or visualizing

```
After obtaining the results of de_condition, designing the matrix and obtaining the required p value these values are now annotated with  Biocmanager package 
```{r}
install.packages("BiocManager")
install.packages("org.Hs.eg.db")
library(BiocManager)
library(org.Hs.eg.db)



```
```{r}
install.packages("org.Hs.eg.db")
library(org.Hs.eg.db)
columns(org.Hs.eg.db)
```
Now we add anootation filters using keytypes and key filters to check the data
```{r}
keytypes(org.Hs.eg.db)
```

```{r}
keys(org.Hs.eg.db)
```

We can;t undertstand the numerical output and we have to assign them ENSEMBL (D (here)) 
```{r}
keys(org.Hs.eg.db,keytype = "ENSEMBL")[1:5]
```
```{r}
keys(org.Hs.eg.db,keytype = "ENTREZID")[1:5]
```
Both ENSEMBL and ENTREZID are assigned a gene ID according to the respective databases and a unique code is provided to them 
Now we assign gene names and its symbol in the ENSEMBL database 
```{r}
select(org.Hs.eg.db,keys = "ENSG00000158258",
       keytype = "ENSEMBL",columns=c("SYMBOL","GENENAME"))
```
Now annotate this database 
```{r}
AnnotationDbi::select(org.Hs.eg.db,keys ="ENSG00000158258",keytype = "ENSEMBL",column=c("SYMBOL","GENENAME"))
```
Now annotate the whole dataset 
```{r}
library(DESeq2)
DESeq(dds)
```

```{r}
anno<-AnnotationDbi::select(org.Hs.eg.db,keys = rownames(dds),columns = c("SYMBOL","GENENAME"),keytype = "ENSEMBL")
tibble(anno)

```

```{r}
results_annotated<-results(de_conditon,tidy=TRUE)%>%left_join(anno,by=c("row"="ENSEMBL"))
head(results_annotated)
```
Write the csv file 
```{r}
write.csv(results_annotated,file = "De_condition_analysis.csv",row.names = FALSE)
saveRDS(results_annotated,file = "Robjects/de_condition.rds")
```
Exporting normailesed counts 
```{r}
dds <- estimateSizeFactors(dds) 
countmatrix<-counts(dds,normalized=TRUE)
head(countmatrix)

```
```{r}
#creating a ggplot to check the de_conditon database and see if we can generate ggplots accordingly this has been generated with dds and de_condition modified database
ggplot(data = results_annotated) +
  geom_point(mapping = aes(x = GENENAME, y = stat,colour=stat))
```
Creating volcano plots and DSeq 2 analysis 
```{r}
library(ggplot2)
library(DESeq2)
results_condition<-readRDS("C:/Users/parth/OneDrive/Desktop/repet_1/Repeat_1/Robjects/de_condition.rds")
results_condition %>% 
  ggplot(aes(x = log2FoldChange, y = -log10(padj))) + geom_point()
```
```{r}
results_condition %>% 
  mutate(Significant = padj < 0.05 & abs(log2FoldChange) > 2) %>% 
  ggplot(aes(x = log2FoldChange, y = -log10(padj), col=Significant)) + geom_point()
```

Applying the ifelse function 
```{r}
N <- 10
top_genes <- dplyr::slice(results_condition, 1:N) %>% pull(row)

results_condition %>% 
  mutate(Label = ifelse(row %in% top_genes, SYMBOL, "")) %>%  
  ggplot(aes(x = log2FoldChange, y = -log10(padj), label=Label)) + geom_point(alpha=0.4) + geom_text(col="blue")
```

